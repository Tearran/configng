#!/bin/bash

# allows CTRL c to exit
trap "exit" INT TERM

# PATHs
SCRIPT_DIR="$(dirname "$0")"
LIB_DIR="$SCRIPT_DIR/../lib/armbian-config"
tools_dir="$SCRIPT_DIR/../tools"
unset module_options
declare -A framework_options
declare -A system_options
declare -A network_options
declare -A software_options
declare -A module_options
declare -A module_helpers

# Load the initialize modules
source "$LIB_DIR/config.initialize.sh"

# Start loading messages
checkpoint reset
checkpoint debug "Initializing script"

source "$LIB_DIR/config.framework.sh"
checkpoint debug "Load Framework..."

initialize_interface


interface_colors 0
checkpoint debug "Set tui dark background..."

initialize_variables
checkpoint debug "Check Systems variables..."

check_distro_status

source "$LIB_DIR/config.system.sh"
checkpoint debug "Loaded System modules..."

source "$LIB_DIR/config.network.sh"
checkpoint debug "Loaded Network modules..."

source "$LIB_DIR/config.software.sh"
checkpoint debug "Loaded Software modules..."

merge_arrays_into_module_options framework_options system_options software_options network_options module_helpers


case "$1" in
    "--help"|"help"|"-h")
        case "$2" in
            "framework"|"-f") options_list framework_options ;;
            "system"|"-s") options_list system_options ;;
            "network"|"-n") options_list network_options ;;
            "software"|"-p") options_list software_options ;;
            "helpers") options_list module_helpers ;;
            *)
                if [[ -n "$2" ]]; then
                    fn=$(sanitize "$2") || die
                    shift 2
                    "$fn" "help"
                else
                    options_list module_options
                fi
        esac
    ;;
    "")
        interface_colors 4
        checkpoint debug "Launching TUI"
        interface_menu interface_categories
        checkpoint debug "Exited TUI"
        support_armbian_configng
    ;;
    *)
        checkpoint debug "Starting module call"
        fn=$(sanitize "$1") || die
        shift 1
        "$fn" "$@"
        checkpoint debug "Finished module call"
    ;;


esac

checkpoint total
