#!/bin/bash

# allows CTRL c to exit
trap "exit" INT TERM
[[ -d "$script_dir/../tools" ]] && tools_dir="$script_dir/../tools"
[[ ! -d "$script_dir/../lib" && -n "$tools_dir" ]] && die -e "Please run\nbash "$tools_dir/config-assemble.sh" to build the lib directory\n"

# PATH
script_dir="$(dirname "$0")"
SCRIPT_DIR="$(dirname "$0")"
LIB_DIR="$SCRIPT_DIR/../lib/armbian-config"
doc_dir="$script_dir/../share/doc/armbian-config"
DOC_DIR="$SCRIPT_DIR/../share/doc/armbian-config"

declare -A module_options

# Load the initialize modules
source "$LIB_DIR/config.initialize.sh"

# Start loading messages
checkpoint reset
checkpoint debug "Initializing script"

source "$LIB_DIR/config.framework.sh"
checkpoint debug "Load Framework..."

initialize_interface
checkpoint debug "Initialize text user interface ($DIALOG)..."

interface_colors 0
checkpoint debug "Set tui dark background..."

initialize_variables
checkpoint debug "Check Systems variables..."

check_distro_status

source "$LIB_DIR/config.docs.sh"
checkpoint debug "Loaded Help messages..."

source "$LIB_DIR/config.system.sh"
checkpoint debug "Loaded System modules..."

source "$LIB_DIR/config.network.sh"
checkpoint debug "Loaded Network modules..."

source "$LIB_DIR/config.software.sh"
checkpoint debug "Loaded Software modules..."

case "$1" in
    "--help"|"help"|"-h")
        if [[ -n "$2" ]]; then
            fn=$(sanitize "$2") || die
            shift 2
            "$fn" "help"
        else
            _module_list
        fi
    ;;
    
    "")
        interface_colors 4
        checkpoint debug "Launching TUI"
        interface_menu interface_categories
        checkpoint debug "Exited TUI"
        about_armbian_configng
    ;;

    *)
        checkpoint debug "Starting module call"
        fn=$(sanitize "$1") || die
        shift 1
        "$fn" "$@"
        checkpoint debug "Finished module call"
    ;;


esac

checkpoint total
